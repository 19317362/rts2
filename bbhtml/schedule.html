<html>
<head>
  <title>Test page</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta http-equiv="content-language" content="en">
  <meta name="author" content="Petr Kubanek (petr@kubanek.net)">
  <link rel="stylesheet" href="/css/datatables.css"/>
  <link rel="stylesheet" href="/css/jquery-ui.css"/>
</head>

<script language="JavaScript" src="js/equ.js" type="text/javascript"></script>
<script language="JavaScript" src="js/setgetapi.js" type="text/javascript"></script>
<script language="JavaScript" src="js/jquery.js" type="text/javascript"></script>
<script language="JavaScript" src="js/datatables.js" type="text/javascript"></script>
<script language="JavaScript" src="js/jquery-ui.js" type="text/javascript"></script>
<script language='JavaScript'>
$(function() {
  	var tname = $("#name"),
	radec = $("#radec"),
	allFields = $([]).add(tname).add(radec);
	error_function = function(request, desc, exc) {
	}

	$("#create-form").dialog({
		autoOpen: false,
		height: 300,
		width: 350,
		modal: true,
		buttons: [ {
			text: "Ask for target",
			id: 'ask-for-target',
			disabled: true,
			click: function() {
				var bvalid = true;
				var vtname = tname.val();

				if (tname.val().length < 1) {
					tname.addClass('ui-state-error');
					bvalid = false;
				}
				if (radec.val().length < 1) {
				  	// create and display progress bar
					var pb = $('<div><p>Resolving ' + tname.val() + "<br/><div id='resolving-progressbar'></div></p</div>").dialog({
						modal: true
					});
					$('#resolving-progressbar').progressbar({
						value: false
					});
					pb.dialog("open");
					// try only radec - name resolver
					var target = $.getJSON('/api/tbystring?jqapi=1&nearest=5&ts=' + tname.val(), function(data) {
						pb.dialog("close");
						$("#resolved-info-simbad").html('<p>Simbad name: ' + data.name
							+ '</p><p>   RA: ' + (new HMS(data.ra)).toString()
							+ '</p><p>   DEC: ' + (new DMS(data.dec)).toString()
							+ '</p><p>info: ' + data.info + '</p>');
						if (data.nearest.aaData.length > 0)
						{
							var tarTable = $("#resolved-info-nearest-targets").dataTable( {'aaData': data.nearest.aaData, 'bDestroy': true } );
							$("#resolved-info-nearest-targets tbody").click  (function (event) {
								$(tarTable.fnSettings().aoData).each(function () {
									$(this.nTr).removeClass('row_selected');
								});
								$(event.target.parentNode).addClass('row_selected');
							} );
							$("#resolved-info-nearest").css({'visibility':'visible'});
						}
						else
						{
							$("#resolved-info-nearest").css({'visibility':'hidden'});
						}
						$("#resolved-info").dialog("open");
					}).fail(function(jqXHR, textStatus, errorThrown) {
						pb.dialog("close");
						var error = $('<div><p>Error asking for target ' + vtname + '</p></div>').dialog({
							modal: true,
							buttons: {
								"OK": function() {
									$(this).dialog("close");
								}
							}
						});
						error.dialog("open");
					});
				}
				$(this).dialog("close");
			}
		} ],
		close: function() {
			allFields.val("").removeClass("ui-state-error");
		}
	});

	$("#resolved-info").dialog({
		autoOpen: false,
		modal: true,
		buttons: {
			"Create": function() {
				$(this).dialog("close");
			},
			"Cancel": function() {
				$(this).dialog("close");
			}
		}
	});

	$("#name").bind('change input keyup', function(event) {
		$('#ask-for-target').button('option', 'disabled', $('#name').val().length == 0);
	} );
})

// find target of given name(s)
function searchTarget(text, opt, schedb)
{
	function fillTargets(targets)
	{
		opt.length = 0;
		for (i in targets.d)
		{
			var newTarget = document.createElement('option');
			newTarget.value = targets.d[i][0];
			newTarget.text = targets.d[i][1];

			opt.add(newTarget, null);
		}
		if (opt.length > 0)
		{
			schedb.disabled = false;
		}
		else
		{
			schedb.disabled = true;
		}
	}
	jsonCall(encodeURI('api/tbyname?n=' + text), fillTargets);
}

// schedule target
function schedule(tid)
{
	if (tid.options.length == 0)
	{
		alert('You have to search for targets');
	}
	if (tid.selectedIndex == undefined)
	{
		alert('You have to select target from available targets');
	}
	function scheduled(schedule)
	{
		alert('Scheduled with ID ' + schedule.schedule_id);
		window.location='schedules/' + schedule.schedule_id;
	}
	jsonCall(encodeURI('api/schedule_all?tar_id=' + tid.options[tid.selectedIndex].value), scheduled);
}

function new_target(name)
{
	$("#create-form").dialog("open");
}
</script>

<body>
  <div id="create-form" title="Create new target">
    <p class="validateTips">All form fields are required.</p>
    <form>
      <fieldset>
        <label for="name">Name</label>
        <input type="text" name="name" id="name" class="text ui-widget-content ui-corner-all" />
	<br/>
        <label for="radec">RA DEC</label>
        <input type="text" name="radec" id="radec" value="" class="text ui-widget-content ui-corner-all" />
      </fieldset>
    </form>
  </div>

  <div id='resolved-info' title="Resovled target">
    <p><div id='resolved-info-simbad'></div></p>
    <span id='resolved-info-nearest'><div>Nearest</div>
      <table class='display' id='resolved-info-nearest-targets'>
        <thead>
	  <tr>
	    <th>ID</th>
	    <th>Target name</th>
	    <th>RA</th>
	    <th>DEC</th>
	  </tr>
	</thead>
	<tbody>
	  <tr>
	    <td colspan='4' class='dataTables_empty'>Loading data from server</td>
	  </tr>
	</tbody>
      </table>
    </span>
  </div>

  <form name='target'>
    <input type='text' name='target'/>
    <select name='available'></select>
    <button type='button' onClick='searchTarget(this.form.target.value, this.form.available, this.form.schedb);'>Search</button>
    <button name='schedb' type='button' onClick='schedule(this.form.available);' disabled>Schedule</button>
    <button type='button' onClick='new_target(this.form.target.value)'>Create new target</button>
  </form>
</body>
