<html>
<head>
  <title>Test page</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta http-equiv="content-language" content="en">
  <meta name="author" content="Petr Kubanek (petr@kubanek.net)">
  <link rel="stylesheet" href="/css/jquery-ui.css"/>
</head>

<script language="JavaScript" src="js/setgetapi.js" type="text/javascript"></script>
<script language="JavaScript" src="js/jquery.js" type="text/javascript"></script>
<script language="JavaScript" src="js/jquery-ui.js" type="text/javascript"></script>
<script language='JavaScript'>
$(function() {
  	var name = $("#name"),
	radec = $("#radec"),
	allFields = $([]).add(name).add(radec);
	$("#create-form").dialog({
		autoOpen: false,
		height: 300,
		width: 350,
		modal: true,
		buttons: {
			"Create a target": function() {
				var bvalid = true;
				if (name.val().length < 1) {
					name.addClass('ui-state-error');
					bvalid = false;
				}
				if (radec.val().length < 1) {
					// try only radec - name resolver
					var target = $.getJSON('/api/tbystring?ts=' + name.val(), function(data) {
						console.log('received data:' + data);
					}).fail(function(request, desc, exc) {
						$("#target-parse-error-description").text('Error asking for target ');// + name.val() + ':' + desc + ',' + exc);
						$("#target-parse-error").dialog("open");
					})
				}
				$(this).dialog("close");
			}
		},
		close: function() {
			allFields.val("").removeClass("ui-state-error");
		}
	});
	$("#target-parse-error").dialog({
		autoOpen: false,
		modal: true,
		buttons: {
			"OK": function() {
				$(this).dialog("close");
			}
		}
	});
})

// find target of given name(s)
function searchTarget(text, opt, schedb)
{
	function fillTargets(targets)
	{
		opt.length = 0;
		for (i in targets.d)
		{
			var newTarget = document.createElement('option');
			newTarget.value = targets.d[i][0];
			newTarget.text = targets.d[i][1];

			opt.add(newTarget, null);
		}
		if (opt.length > 0)
		{
			schedb.disabled = false;
		}
		else
		{
			schedb.disabled = true;
		}
	}
	jsonCall(encodeURI('api/tbyname?n=' + text), fillTargets);
}

// schedule target
function schedule(tid)
{
	if (tid.options.length == 0)
	{
		alert('You have to search for targets');
	}
	if (tid.selectedIndex == undefined)
	{
		alert('You have to select target from available targets');
	}
	function scheduled(schedule)
	{
		alert('Scheduled with ID ' + schedule.schedule_id);
		window.location='schedules/' + schedule.schedule_id;
	}
	jsonCall(encodeURI('api/schedule_all?tar_id=' + tid.options[tid.selectedIndex].value), scheduled);
}

function new_target(name)
{
	$("#create-form").dialog("open");
}
</script>

<body>
  <div id="create-form" title="Create new target">
    <p class="validateTips">All form fields are required.</p>
    <form>
      <fieldset>
        <label for="name">Name</label>
        <input type="text" name="name" id="name" class="text ui-widget-content ui-corner-all" />
	<br/>
        <label for="radec">RA DEC</label>
        <input type="text" name="radec" id="radec" value="" class="text ui-widget-content ui-corner-all" />
      </fieldset>
    </form>
  </div>

  <div id="target-parse-error" title="Error parsing target request">
    <p><span class='ui-icon ui-icon-alert' style='float: left; margin: 0 7px 20px 0;'></span><div id='target-parser-error-description'>Test</div></p>
  </div>

  <form name='target'>
    <input type='text' name='target'/>
    <select name='available'></select>
    <button type='button' onClick='searchTarget(this.form.target.value, this.form.available, this.form.schedb);'>Search</button>
    <button name='schedb' type='button' onClick='schedule(this.form.available);' disabled>Schedule</button>
    <button type='button' onClick='new_target(this.form.target.value)'>Create new target</button>
  </form>
</body>
