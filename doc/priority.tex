\subsection{Priority}

Z~hlediska priorit je mo¾né v¹echny funkce, které mù¾e zaøízení vykonávat, na
dvì disjunktní mno¾iny:

\begin{description}
\index{funkce!informaèní@}\item[informaèní]{poskytují informace o~stavu zaøízení}
\index{funkce!výkoné@}\item[výkoné neboli exekuèní]{mìní stav zaøízení}
\end{description}

Informaèní funkce mohou být volnì pøístupné, nevadí, pokud je bude
volat více klientù najednou. Je vìcí ovladaèe zaøízení, aby správnì
vykonal více volání informaèních funkcích, pøicházejících ve stejnou
dobu.

Naopak exekuèní funkce nemohou být volnì pøístupné. Pøístup k~nim je
potøeba hlídat.\footnote{nedává napøíklad moc smysl, aby jeden klientský
proces spustil na kameøe expozici a druhý proces jí zastavil. Stejnì tak
nedává smysl, aby bì¾eli dvì exekuèní funkce najednou - napøíklad pøesun
dalekohledu na pozici x,y a u,v}

Jediné øe¹ení, které mì napadlo, je pou¾ít exkluzivního pøístupu
k~exekuèním funkcím - pouze jeden klient mù¾e volat exekuèní funkce,
ostatní klienti pøi volání exkuèní funkce obdr¾í chybovou zprávu,
oznamující, ¾e funkci nemohou zavolat. Je pak na nich, aby se
rozhodli, jak budou dále postupovat.

Je potøeba zajistit výbìr klienta, který bude mít exkluzivní pøístup.
Máme dvì mo¾nosti:

\begin{enumerate}
\item dopøedu v¹e naplánovat tak, aby takovýto klient byl v~v¾dy pouze
jeden
\item v~prùbìhu pozorování nìjakým postupem urèovat klienta
s~exkluzivním pøístupem
\end{enumerate}

Dopøedu plánovat moc nelze - detekci gama zábleskù nelze dopøedu
pøedpovídat. První mo¾nost je tedy pro nás nevhodná.

Mechanismus na urèení vhodného klienta mù¾e vypadat napøíklad takto:

\begin{itemize}
\item ka¾dému klientu je pøidìlena hodnota, vyjadøující jak moc trvá
na exkluzivním pøístupu - prioritu
\item pøi pøipojení nového klienta je jeho priorita nastavena na
základní hodnotu 
\item klient mù¾e svoji prioritu zvy¹ovat, nebo sni¾ovat
\item klient s~nejvy¹¹í prioritou má pøístup k~exkluzivním funkcím
\item v~pøípadì, ¾e má nìkolik klientù stejnou, nejvy¹¹í prioritu,
rozhoduje nìjaký mechanismus
\end{itemize}

Klient s~pøístupem k~exkluzivním funkcím je mù¾e vykonávat, ostatní
klienti obdr¾í pøi volání prioritních funkcí chybovou hlá¹ku.

Je potøeba doøe¹it detaily ohlednì pøesného postupu pøedávání priorit.

K~zaøízení se mohou hlásit a nastavovat svoji prioritu noví klienti,
pøipojení klienti mohou svoji prioritu mìnit, exekuèní funkce mohou
trvat del¹í dobu \footnote{typickým pøíkladem je pøesun dalekohledu}.
Bude tedy docházet k~situacím, kdy na zaøízení pro jednoho klienta
bì¾í exekuèní funkce, zatímco druhý klient ¾ádá o~zmìnu priority, po
jejím¾ provedení by se stal klientem s~nejvy¹¹í prioritou - viz
následující diagram:

\dia{kill-pre.eps}{Nový klient ¾ádající o zmìnu priority}

Nemá smysl èekat s~ukonèením aktivní exekuèní funkce do okam¾iku, kdy
klient s~vy¹¹í prioritou po¾ádá o~vykonání exekuèní funkce - je
rozumné oèekávat, ¾e po¾adavek o~vykonání exekuèní funkce bude
následovat hned za po¾adavkem na zmìnu prioritu. Za cenu znaèného
nárustu slo¾itosti kódu bych získal nìco málo èasu. Viz následující
diagram:

\dia{kill-nextexe.eps}{Odlo¾ení ukonèení exkluzivní funkce do nového
volání}

Je tedy vhodné ji¾ pøi zmìnì priority zajistit, ¾e zaøízení bude
pøipraveno pøijímat exekuèní funkce - na zaøízení nesmí bì¾et ¾ádné
exekuèní funkce.

Zbývají tøi mo¾nosti, jak po¾adavek na zmìnu priority o¹etøit:

\begin{enumerate}
\item okam¾itì ukonèit volání právì provádìné exekuèní funkce a zmìnit
poøadí priorit
\item poèkat se zmìnou priorit, ukonèit exekuèní funkce a zmìnit
prioritu
\item ignorovat po¾adavek na zmìnu priorit, poslat zpìt chybové
hlá¹ení 
\end{enumerate}

První pøípad bude pou¾it, pokud dorazí neodkladné nové pozorování,
pøípadnì bude potøeba uskuteènit nìjaké periodické mìøení opravdu
v~daný èas - tì¾ko lze pøipustit, aby pozorování optických dosvitù gama
zábleskù bylo zpo¾dìno by» o~nìkolik málo desítek sekund, které
rozhodují o~úspìchu èi neúspìchu pozorování.

Poslední pøípad by mohl nastat, pokud dojde pøi ukonèování aktivní
exekuèní funkce k~chybì. Je ale otázkou, zda má význam - exekuèní
funkce by mìli býti v¾dy pøeru¹itelné. Jinak nemá smysl po¾adavek na
zmìnu priority odmítat.

Prostøední pøípad je nejzajímavìj¹í.  Okam¾ik, kdy bude ukonèeno
provádìní exekuèní funkce, lze samozøejmì zvolit libovolnì, ideálnì
tak, aby v~daný okam¾ik neprobíhala ¾ádná exekuèní funkce.

Motivace implemetace tohoto pøípadu spoèívá v~mo¾nosti nechat
dobìhnout právì provádìné pozorování tak, abychom i z~pøeru¹eného
pozorování získali nìjaké výsledky. Je napøíklad ¹koda, pokud jednu
sekundu pøed ukonèením vyèítání kamery získá exkluzivní pøístup jiný
klient se zhruba stejnou prioritou - takto ztratím výsledky
nìkolikaminutového experimentu, pøesto¾e by staèilo právì tu jednu
sekundu poèkat na ukonèení vyèítání kamery.

Dal¹í zajímavou mo¾ností je dovyètení kamery v~prùbìhu pøesunu
dalekohledu na nové pozorování - s~ukonèením vyèítání mohu poèkat do
okam¾iku, kdy dalekohled dosáhne nové pozice, pøípadnì kdy klient
s~vy¹¹í prioritou zaène pou¾ívat na kameøe exekuèní funkce. Je ale tøeba
dbát na to, aby se dalekohled nepohyboval v~prùbìhu expozice. 

Máme následující mo¾nosti, jak dlouho èekat:

\begin{enumerate}
\item pøedem danou dobu
\item poèkat na dokonèení probíhající exekuèní funkce
\item poèkat na dokonèení probíhajícího bloku exekuèních funkcí
\end{enumerate}

První øe¹ení nepøiná¹í, hlavnì ve srovnání s~dal¹ími, ¾ádné výhody.
Pouze mù¾eme ztratit pozorovací èas.

Druhý pøípad nemá moc význam - tím, ¾e nechám dobìhnout expozici, nic
nezískám, jeliko¾ exponovaný snímek nevyètu - zabrání mì v~tom
pøítomnost klientu s~vy¹¹í prioriotu.

\dia{kill-waitexe.eps}{Èekání do ukonèení aktuální exepozice}

Tøetí pøípad pøiná¹í nejvíce u¾itku - se zmìnou priority se èeká tak
dlouho, dokud není dokonèena èást pozorování, z~pøeru¹ovaného
pozorování získám urèité výsledky, dalekohled bude optimálnì vyu¾it. 

\dia{kill-waitblock.eps}{Èekání do ukonèení aktuálního bloku}

\subsubsection{Závìr}

Pou¾ijeme priorit. Do plánovaèe zabudujeme bloky.

Mechanizmus pøedávání priorit.

Zaøízení vìdí, jaký klient má u~nich nejvìt¹í prioritu. Ze serveru jim
chodí zprávy, které je informují o~zmìnì priority. Pokud dojde zpráva
o~zmìnì priority na klienta s~jiným identifikaèním èíslem ne¾ je
klient který má nejvy¹¹í prioritu, zaøízení pøeru¹í právì probíhající
pozorování, pøedá øízení novému klientu a ode¹le zpìt potvrzení
o~zmìnì priority.
