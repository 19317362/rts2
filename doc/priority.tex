\section{Priority}

Z~hlediska priorit je mo¾né v¹echny funkce, které mù¾e agent vykonávat,
rozdìlit na dvì disjunktní mno¾iny:

\begin{description}
\index{funkce!informaèní}\item[informaèní]{poskytují informace o~stavu zaøízení}
\index{funkce!výkoné}\item[výkonné neboli exekuèní]{mìní stav zaøízení}
\end{description}

Informaèní funkce mohou být volnì pøístupné, nevadí, pokud je bude
volat více klientù najednou. Je vìcí ovladaèe zaøízení, aby správnì
provedl volání více informaèních funkcích, pøicházejících ve stejnou dobu.

Naopak exekuèní funkce nemohou být volnì pøístupné. Pøístup k~nim je tøeba
hlídat.\footnote{nedává napøíklad moc smysl, aby jeden klient spustil na
kameøe expozici a druhý klient jí zastavil. Stejnì tak nedává
smysl, aby bì¾ely dvì exekuèní funkce najednou - napøíklad pøesun dalekohledu
na pozici x,y a u,v}

Pou¾ívá se exkluzivního pøístupu k~exekuèním funkcím - nanejvý¹e jeden klient
mù¾e volat exekuèní funkce, ostatní klineti pøi volání exekuèní funkce obdr¾í
chybovou zprávu, oznamující, ¾e funkci nemohou zavolat. Je pak na nich, aby se
rozhodli, jak budou dále postupovat.

Je tøeba zajistit výbìr klienta, který bude mít exkluzivní pøístup.
Máme dvì mo¾nosti:

\begin{enumerate}
\item dopøedu v¹e naplánovat tak, aby takovýto klient byl v¾dy pouze
jeden
\item v~prùbìhu pozorování nìjakým postupem urèovat klienta
s~exkluzivním pøístupem
\end{enumerate}

Dopøedu moc plánovat nelze - detekci gama zábleskù nelze dopøedu
pøedpovídat. První mo¾nost tedy nelze pou¾ít.

Mechanismus na urèení vhodného klienta mù¾e vypadat napøíklad takto:

\begin{itemize}
\item ka¾dý klient vlastní èíslo, vyjadøující jak moc trvá
na exkluzivním pøístupu - prioritu
\item pøi pøipojení nového klienta je jeho priorita nastavena na
základní hodnotu 
\item klient mù¾e svoji prioritu zvy¹ovat, nebo sni¾ovat
\item klient s~nejvy¹¹í prioritou má pøístup k~exekuèním funkcím
\item pøístup k exekuèním funkcím nelze získat zvý¹ením priority na stejnou
hodnotu, jako má aktuální klient s pøístupem k exekuèním funkcím
\item pokud má více klientù stejnou, nejvy¹¹í prioritu, klient, který získá
pøístup k exekuèním funkcím je zvolen náhodnì
\end{itemize}

Je dobré si uvìdomit, ¾e poslední mo¾nost mù¾e nastat pouze v pøípadì, ¾e
klient s nejvy¹í prioritou se buïto odpojí od systému, nebo sní¾í svoji
prioritu pod hodnotu nìkterých jiných agentù.

\subsection{Mo¾nosti pøedávání priorit}

\dia{kill-pre}{Nový klient ¾ádající o~zmìnu priority}

K~zaøízení se mohou hlásit a nastavovat svoji prioritu noví klienti,
pøipojení klienti mohou svoji prioritu mìnit, exekuèní funkce mohou
trvat del¹í dobu\footnote{typickým pøíkladem je pøesun dalekohledu}.
Bude tedy docházet k~situacím, kdy na zaøízení pro jednoho klienta
bì¾í exekuèní funkce, zatímco druhý klient ¾ádá o~zmìnu priority, po
jejím¾ provedení by se stal klientem s~nejvy¹¹í prioritou - viz diagram
\ref{fig:kill-pre}. 

Nemá smysl èekat s~ukonèením aktivní exekuèní funkce do okam¾iku, kdy
klient s~vy¹¹í prioritou po¾ádá o~vykonání exekuèní funkce - je rozumné
oèekávat, ¾e po¾adavek o~vykonání exekuèní funkce bude následovat hned za
po¾adavkem na zmìnu prioritu. Za cenu znaèného nárùstu slo¾itosti kódu by
systém získal nìco málo èasu. Viz diagram \ref{fig:kill-nextexe}.

\dia{kill-nextexe}{Odlo¾ení ukonèení exekuèní funkce do nového volání}

Je tedy vhodné ji¾ pøi zmìnì priority zajistit, ¾e zaøízení bude
pøipraveno pøijímat exekuèní funkce - na zaøízení nesmí bì¾et ¾ádné
exekuèní funkce.

Jsou tøi mo¾nosti, jak po¾adavek na zmìnu priority o¹etøit:

\begin{enumerate}
\item okam¾itì ukonèit volání právì provádìné exekuèní funkce a zmìnit
poøadí priorit
\item poèkat, ukonèit exekuèní funkce, poté zmìnit poøadí priorit
\item ignorovat po¾adavek na zmìnu priorit, poslat zpìt chybové
hlá¹ení 
\end{enumerate}

První pøípad bude pou¾it, pokud dorazí neodkladné nové pozorování, pøípadnì
bude tøeba uskuteènit nìjaké periodické mìøení opravdu v~daný èas - tì¾ko lze
pøipustit, aby pozorování optických dosvitù gama zábleskù bylo zpo¾dìno by»
o~nìkolik málo desítek sekund, které rozhodují o~úspìchu èi neúspìchu
pozorování.

Poslední pøípad by mohl nastat, pokud dojde pøi ukonèování aktivní exekuèní
funkce k~chybì. Je ale otázkou, zda má význam - exekuèní funkce by mìli být
v¾dy pøeru¹itelné. V jiných pøípadech nemá smysl po¾adavek na zmìnu priority
odmítat.

Prostøední pøípad je nejzajímavìj¹í.  Okam¾ik, kdy bude ukonèeno
provádìní exekuèní funkce, lze samozøejmì zvolit libovolnì, ideálnì
tak, aby v~daný okam¾ik neprobíhala ¾ádná exekuèní funkce.

Motivace tohoto pøípadu spoèívá v~mo¾nosti nechat dobìhnout právì provádìné
pozorování tak, abychom i z~pøeru¹eného pozorování získali nìjaké výsledky. Je
napøíklad ¹koda, pokud jednu sekundu pøed ukonèením vyèítání kamery získá
exkluzivní pøístup jiný klient se zhruba stejnou prioritou - takto ztratím
výsledek nìkolikaminutového experimentu. Pøitom by staèilo chvíly poèkat, a
snímek bych vyèetl celý.

Dal¹í zajímavou mo¾ností je dovyètení kamery v~prùbìhu pøesunu dalekohledu na
pozici nového cíle - s~ukonèením vyèítání mohu poèkat do okam¾iku, kdy
dalekohled dosáhne nové pozice, pøípadnì kdy klient s~vy¹¹í prioritou zaène
pou¾ívat na kameøe exekuèní funkce. Je ale tøeba dbát na to, aby se dalekohled
v~prùbìhu expozice nepohyboval.

Nabízejí se následující mo¾nosti, jak dlouho èekat:

\begin{enumerate}
\item pøedem danou dobu
\item poèkat na dokonèení probíhající exekuèní funkce
\item poèkat na dokonèení probíhajícího bloku exekuèních funkcí
\end{enumerate}

První øe¹ení nepøiná¹í ¾ádné výhody. V náhodných pøípadech se podaøí
pozorovaní dokonèit, v ostatních pouze ztratíme èas.

Druhý pøípad mù¾e také vést ke ztrátì èasu - napøíklad tím, ¾e expozice
dobìhne, nezíská systém ¾ádný pou¾itelný výsledek, jeliko¾ naexponovaný snímek
nebude vyèten - zabrání v~tom pøítomnost klientu s~vy¹¹í prioritu. Toto je
znázornìno na diagramu \ref{fig:kill-waitexe}.

\dia{kill-waitexe}{Èekání do ukonèení aktuální expozice}

Lze namítnou, ¾e problém s vyèítáním naexponovaného snímku je mo¾né vyøe¹it
pou¾itím funkce, která nejdøíve snímek naexponuje a pak teprve vyète.
Pozorování ale mohou pro alespoò èásteènu pou¾itelnost vy¾adovat nìkolik
snímkù v rùzných filtrech, nebo napøíklad korekèní expozice a skuteèné
expozice.

Pouze tøetí pøípad pøiná¹í u¾itek - se zmìnou priority se èeká tak dlouho,
dokud není dokonèena èást pozorování, z~pøeru¹ovaného pozorování máme k
dispozici výsledky, dalekohled bude optimálnì vyu¾it.

Za definování zaèátku a konce bloku je zodpovìdný klient. Definování blokù
probíhá po zaøízeních, bloky se jednotlivých zaøízení systému nemusí
schodovat.

\dia{kill-waitblock}{Èekání do ukonèení aktuálního bloku}

\subsection{Závìr}

\begin{itemize}

\item Pou¾ijeme priorit. Komunikace mezi klienty a zaøízeními obsahuje
pøíkazy pro zahájní a ukonèení bloku.

\item Priorita se mìní buï okam¾itì (vhodné pro GRB), nebo s èekáním do
ukonèení bloku (vhodné pro dlouhodobý plánovaè).

\item ®ádost o prioritu je pøedávána na centrální server, který ji distribuuje
zaøízením. Ty pak informují klienty o splnìní ¾ádosti. 

\end{itemize}

Øe¹ení dovyètení kamery a souèasného zahájení pøesunu na novou pozici vypadá
následovnì:

\begin{itemize}

\item prioritu má klient {\it A}

\item {\it A} po¾ádá kameru o zahájení vyèítání 

\item {\it A} ukonèí na montá¾i blok

\item o prioritu po¾ádá klient {\it B}

\item {\it B} obdr¾í prioritu na montá¾i

\item {\it B} provede pøesun montá¾e na novou pozici

\item kamera ukonèí vyèítání

\item {\it A} ukonèí na kameøe blok

\item {\it B} obdr¾í prioritu na kameøe

\item {\it B} zahájí expozici na kameøe

\end{itemize}
