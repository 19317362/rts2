\section{Priority}

Ka¾dá funkce, která mù¾e být agentem volána, je prvkem právì jedné z
následujících dvou mno¾in:

\begin{description}
\index{funkce!informaèní}\item[mno¾ina informaèních funkcí]{obsahuje funkce,
které poskytují informace o~stavu zaøízení}
\index{funkce!výkoné}\item[mno¾ina exekuèních funkcí]{obsahuje funkce, které
mìní stav zaøízení}
\end{description}

Informaèní funkce mohou být volnì pøístupné. Více klientù je mù¾e volat ve
stejnou dobu. Za jejich správné provedení je odpovìdný ovladaè zaøízení.
Vykonávání informaèních funkcí trvá krátkou dobu. Nelze je pøeru¹it.

Exekuèní funkce nemohou být volnì pøístupné\footnote{napøíklad není vhodné,
aby jeden klient pohyboval dalekohledem a druhý exponoval kamery}. Exekuèní
funkce lze v libovolný okam¾ik pøeru¹it. 

Systém pou¾ívá exkluzivního pøístupu k~exekuèním funkcím - nanejvý¹e jeden
klient mù¾e volat exekuèní funkce, ostatní klienti pøi volání exekuèní funkce
obdr¾í chybovou zprávu, oznamující, ¾e funkci nemohou zavolat. Je pak na nich,
aby se rozhodli, jak budou dále postupovat.

Je tøeba zajistit výbìr klienta, který bude mít exkluzivní pøístup.
Máme dvì mo¾nosti:

\begin{enumerate}
\item pøipravit plán pozorování tak, aby klient s exkluzivním pøístupem byl v¾dy pouze
jeden
\item v~prùbìhu pozorování urèovat klienta s~exkluzivním pøístupem
\end{enumerate}

Detekci gama zábleskù není mo¾né pøedpovìdìt. Proto není mo¾né dopøedu
pøipravit plán pozorování. První mo¾nost tedy nelze pou¾ít.

Mechanismus na urèení vhodného klienta bude vypadat takto:

\begin{itemize}
\item ka¾dý klient vlastní èíslo, vyjadøující jak moc trvá na exkluzivním
pøístupu - prioritu
\item pøi pøipojení nového klienta je jeho priorita nastavena na
základní hodnotu 
\item klient mù¾e svoji prioritu zvy¹ovat, nebo sni¾ovat
\item klient s~nejvy¹¹í prioritou má pøístup k~exekuèním funkcím
\item pøístup k exekuèním funkcím nelze získat zvý¹ením priority na stejnou
hodnotu, jako má aktuální klient s pøístupem k exekuèním funkcím
\item pokud má více klientù stejnou, nejvy¹¹í prioritu, klient, který získá
pøístup k exekuèním funkcím je zvolen náhodnì
\end{itemize}

Je dobré si uvìdomit, ¾e poslední mo¾nost mù¾e nastat pouze v pøípadì, ¾e
klient s nejvy¹í prioritou se buïto odpojí od systému, nebo sní¾í svoji
prioritu.

\subsection{Mo¾nosti pøedávání priorit}

\dia{kill-pre}{Nový klient ¾ádající o~zmìnu priority}

K~zaøízení se mohou hlásit a nastavovat svoji prioritu noví klienti,
pøipojení klienti mohou svoji prioritu mìnit, exekuèní funkce mohou
trvat del¹í dobu\footnote{typickým pøíkladem je pøesun dalekohledu}.
Bude tedy docházet k~situacím, kdy na zaøízení pro jednoho klienta
bì¾í exekuèní funkce, zatímco druhý klient ¾ádá o~zmìnu priority, po
jejím¾ provedení by se stal klientem s~nejvy¹¹í prioritou - viz diagram
\ref{fig:kill-pre}. 

Nemá smysl èekat s~ukonèením aktivní exekuèní funkce do okam¾iku, kdy
klient s~vy¹¹í prioritou po¾ádá o~vykonání exekuèní funkce - je rozumné
oèekávat, ¾e po¾adavek o~vykonání exekuèní funkce bude následovat hned za
po¾adavkem na zmìnu prioritu. Za cenu znaèného nárùstu slo¾itosti kódu by
systém získal nìco málo èasu. Viz diagram \ref{fig:kill-nextexe}.

\dia{kill-nextexe}{Ukonèení exekuèní funkce odlo¾ené do nového volání}

Je tedy vhodné ji¾ pøi zmìnì priority zajistit, ¾e zaøízení bude
pøipraveno pøijímat exekuèní funkce - zaøízení nesmí pøi pøedávání priority
provádìt exekuèní funkce.

Je potøeba rozli¹it dva pøípady, jak bude po¾adavek na zmìnu priority o¹etøen:

\begin{enumerate}
\item okam¾itì ukonèit volání právì provádìné exekuèní funkce a zmìnit
poøadí priorit
\item poèkat, ukonèit exekuèní funkce, poté zmìnit poøadí priorit
\end{enumerate}

První pøípad bude pou¾it, pokud dorazí neodkladné nové pozorování, pøípadnì
bude tøeba uskuteènit nìjaké periodické mìøení opravdu v~daný èas - tì¾ko lze
pøipustit, aby pozorování optických dosvitù gama zábleskù bylo zpo¾dìno by»
o~nìkolik málo desítek sekund, které rozhodují o~úspìchu èi neúspìchu
pozorování.

Motivace druhého pøípadu spoèívá v~mo¾nosti nechat dobìhnout právì provádìné
pozorování tak, abychom i z~pøeru¹eného pozorování získali výsledky. Je
napøíklad ¹koda, pokud jednu sekundu pøed ukonèením vyèítání kamery získá
exkluzivní pøístup jiný klient se zhruba stejnou prioritou - takto ztratíme
výsledek nìkolikaminutového experimentu. Pøitom staèí s pøedáním priority
chvíli poèkat, ne¾ bude vyèten celý snímek.

Dal¹í zajímavou mo¾ností je dovyètení kamery v~prùbìhu pøesunu montá¾e na
pozici nového cíle - s~ukonèením vyèítání mohu poèkat do okam¾iku, kdy
dalekohled dosáhne nové pozice.

Nabízejí se následující mo¾nosti, jak dlouho èekat:

\begin{enumerate}
\item pøedem danou dobu
\item poèkat na dokonèení probíhající exekuèní funkce
\item poèkat na dokonèení probíhajícího bloku exekuèních funkcí
\end{enumerate}

První øe¹ení nepøiná¹í ¾ádné výhody. V náhodných pøípadech se podaøí
pozorovaní dokonèit, v ostatních pouze ztratíme èas.

Druhý pøípad mù¾e také vést ke ztrátì èasu - napøíklad tím, ¾e expozice
dobìhne, nezíská systém ¾ádný pou¾itelný výsledek, jeliko¾ naexponovaný snímek
nebude vyèten - zabrání v~tom pøítomnost klientu s~vy¹¹í prioritu. Toto je
znázornìno na diagramu \ref{fig:kill-waitexe}.

\dia{kill-waitexe}{Èekání do ukonèení aktuální expozice}

Lze namítnou, ¾e problém s vyèítáním naexponovaného snímku je mo¾né vyøe¹it
pou¾itím funkce, která nejdøíve snímek naexponuje a následnì vyète.
Pozorování ale mohou pro alespoò èásteènou pou¾itelnost vy¾adovat provedení
nìkolika funkcí, volaných na nìkolika rùzných zaøízeních. Pøíkladem mù¾e být
poøízení druhého snímku na jiných souøadnicích, ne¾ byl poøízen první snímek.
Pøidáním nové funkce tento pøípad nevyøe¹íme.

Pouze tøetí pøípad pøiná¹í u¾itek - se zmìnou priority se èeká tak dlouho,
dokud není dokonèena èást pozorování, z~pøeru¹ovaného pozorování máme k
dispozici výsledky, dalekohled bude optimálnì vyu¾it.

Za definování zaèátku a konce bloku je zodpovìdný klient. Definování blokù
probíhá po zaøízeních, bloky se na jednotlivých zaøízeních systému nemusí
shodovat.

\dia{kill-waitblock}{Èekání do ukonèení aktuálního bloku}

\subsection{Závìr}

\begin{itemize}

\item Pou¾ijeme priorit. Komunikace mezi klienty a zaøízeními obsahuje
pøíkazy pro zahájení a ukonèení bloku.

\item Priorita se mìní buï okam¾itì (vhodné pro reakci na GRB), nebo s èekáním
do ukonèení bloku (vhodné pro dlouhodobý plánovaè).

\item ®ádost o prioritu je pøedávána na centrální server, který ji distribuuje
zaøízením. Ta pak informují klienty o splnìní ¾ádosti. 

\end{itemize}

\subsection{Pøíklady}

Øe¹ení dokonèení vyètení kamery a souèasného zahájení pøesunu na novou pozici
vypadá následovnì:

\begin{itemize}

\item prioritu má klient {\it A}

\item {\it A} po¾ádá kameru o zahájení vyèítání 

\item {\it A} ukonèí na montá¾i blok

\item o prioritu po¾ádá klient {\it B}

\item {\it B} obdr¾í prioritu na montá¾i

\item {\it B} provede pøesun montá¾e na novou pozici

\item kamera ukonèí vyèítání

\item {\it A} ukonèí na kameøe blok

\item {\it B} obdr¾í prioritu na kameøe

\item {\it B} zahájí expozici na kameøe

\end{itemize}

V následujícím pøíkladu je popsáno pøedávání priorit mezi tøemi klienty.
Klientem {\it col}, který poøizuje barevné snímky oblohy, pro které potøebuje
snímek poøízený pøes tøi filtrová kola R V a I. Klientem {\it var} , který
monitoruje promìnnou hvìzdu, pro který je tøeba nasnímat dva snímky. A klientem
{\it grbc}, který hledá optické protìj¹ky gama záblesku, který okam¾itì po
obdr¾ení zprávy o gama záblesku nasmìruje dalekohled na novou pozici a zaène
pozorovat.

\begin{itemize}

\item prioritu má klient {\it col}

\item {\it col} zahájí expozici prvního snímku ve filtru R

\item {\it col} vyète první snímek

\item {\it col} zahájí expozici druhého snímku ve filtru V

\item o prioritu po¾ádá {\it var}

\item {\it col} vyète druhý snímek

\item {\it col} zahájí expozici tøetího snímku ve filtru I

\item {\it col} zahájí vyèítání tøetího snímku

\item {\it col} ukonèí na montá¾i blok

\item {\it var} obdr¾í prioritu na montá¾i

\item {\it var} zahájí pøesun montá¾e na novou pozici

\item {\it col} dokonèí vyètení tøetího snímku

\item {\it col} ukonèí na kameøe blok

\item {\it var} obdr¾í na kameøe prioritu

\item {\it var} v pøípadì, ¾e se montá¾ je¹tì stále pohybuje, poèká do ukonèení pøesunu

\item {\it var} zahájí expozici prvního snímku na kameøe

\item {\it var} zahájí vyèítání kamery

\item {\it grbc} obdr¾í zprávu o gamma záblesku

\item {\it grbc} zjistí, ¾e pozice gamma záblesku je pozorovatelná

\item o prioritu po¾ádá {\it grbc}

\item dojde k ukonèení vyèítání kamery

\item {\it var} obdr¾í zprávu o odejmutí priority

\item {\it grbc} obdr¾í na montá¾i i kameøe prioritu

\item {\it grbc} zahájí pøesun montá¾e

\item {\it grbc} poèká na ukonèení pøesunu montá¾e

\item {\it grbc} zahájí expozici na kameøe

\end{itemize}
