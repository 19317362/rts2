\chapter{Protokol}

\def\comname#1#2#3{
\noskip{\bf #1} {\it #2} #3
\newline}

\def\comvalue#1#2#3{
{\it #1} { #2} #3
\newline}

\def\comret#1#2{
{\it E:}{\bf #1} #2
\newline}

\section{Konvence}

{\bf Tuène} je vysázeno jméno pøíkazu a jméno návratové hodnoty.

{\it Kurzívou a v [hranatých závorkách]} jsou vysázeny parametry
pøíkazu, a návratové hodnoty na øádce.

\section{Obecné návratové hodnoty}

Zaøízení vrací 0, pokud po¾adovaná operace probìhla úspì¹nì. Pokud
pøíkaz neexistuje, nebo klient není autorizován pro provádìní daného
pøíkazu, vrací hodnotu DEVDEM\_E\_COMMAND. Pokud je pro pøíkaz zadán
nesprávný poèet parametrù, vrací hodnotu DEVDEM\_E\_PARAMSVAL.

\section{Serverd}

\subsection{Inicializaèní pøíkazy}

\comname{login}{[jméno u¾ivatele]}{pøihlásí u¾ivatele do systému}
\comret{DEVDEM\_E\_COMMAND}{klient je ji¾ pøihlá¹en nebo registrován}
\comret{DEVDEM\_E\_SYSTEM}{není mo¾né pøihlásit dal¹ího u¾ivatele}

\comname{password}{[heslo]}{po¹le heslo u¾ivatele}
\comvalue{logged\_as}{[èíslo spojení]}{èíslo spojení na stranì serveru,
pou¾ívané pro dal¹í autentifikaci}
\comvalue{I status\_num}{[poèet stavù]}{}
\comvalue{I status}{[èíslo stavu] [název stavu] [souèasná hodnota stavu]}{}
\comret{DEVDEM\_E\_SYSTEM}{heslo neodpovídá}

\comname{register}{[jméno zaøízení] [typ zaøízení] [host]:[port]}{zaregistruje nové zaøízení}
\comret{DEVDEM\_E\_SYSTEM}{zaøízení se stejným jménem je ji¾
zargistrováno}

\subsection{Informaèní pøíkazy}

\comname{info}{}{vypí¹e informace o pøipojených zaøízeních a pøipojených klientech}
\comvalue{user}{[id] [priorita] [*|-] [jméno u¾ivatele] [popis provádìnné èinnosti]}
{informace o pøipojeném u¾ivateli - jeho èíslo, priority, zda je klientem s
nejvy¹í prioritou èi ne, a struèný popis, o jakého klienta se jedná}
\comvalue{device}{[èíslo zaøízení] [jméno zaøízení] [host]:[port] [typ zaøízení]}
{informace o pøipojeném zaøízení}
 
\comname{key}{[jméno zaøízení]}{vy¾ádá si klíè pro autorizaci}
\comvalue{authorization\_key}{[jméno zaøízení] [klíè]}{autorizaèní
klíè pro dané zaøízení}
\comret{DEVDEM\_E\_SYSTEM}{zaøízení neexisuje}

\comname{priority}{[nová priorita]}{zmìní prioritu daného spojení}
\comvalue{old\_priority}{[hodnota priority]}{souèasná priorita spojení}
\comvalue{actual\_priority}{[èíslo spojení dr¾ícího prioritu]
[hodnota jeho priority]}{spojení s nejvìt¹í prioritou}
{new\_priority}{[èíslo spojení dr¾ící prioritu] [hodnota priority]}
{spojení s prioritou po provedení zmìny}
\comret{DEVDEM\_E\_PRIORITY}{pokud zmìna priority nemohla probìhnout}

\comname{prioritydeferred}{[nová priorita]}{provede zmìnu odlo¾enou
zmìnu priroty}

\comname{on}{}{zmìní stav serveru na jeden z operaèních stavù, v
závislosti na aktuálním èase a datu}

\comname{off}{}{zmìní stav serveru na off - vypnuto}

\section{Zaøízení - obecná komunikace}

Pokud není klient autorizován, vrací v¹echna komunikace hodnotu
DEVDEM\_E\_SYSTEM.

Pokud dojde pøi vykonávání pøíkazu k chybì v komunikaci se zaøízením,
vrací se hodnota DEVDEM\_E\_HW.

\comname{auth}{[èíslo spojení] [autentifikaèní klíè]}{provede
autorizaci}
\comvalue{I status\_num}{[poèet stavù]}{}
\comvalue{I status}{[èíslo stavu] [jméno stavu] [hodnota stavu]}{}
{informace o stavu zaøízení}{}
\comret{DEVDEM\_E\_SYSTEM}{pokud autorizace neprobìhla}

\comname{ready}{}{zjistí, jestli je zaøízení pøipojeno. Je mo¾né volat
opakovanì.}

\comname{help}{}{vypí¹e nápovìdu}

\comname{exit}{}{ukonèí spojení}

\comname{blockstart}{}{informuje zaøízení o zaèátku bloku, nutné pro
provedení odlo¾ené zmìny priority}
\comret{DEVDEM\_E\_SYSTEM}{pokud je spojení ji¾ v bloku}

\comname{blockcheck}{}{odlo¾ená zmìna priority je mo¾ná}
\comret{DEVDEM\_E\_SYSTEM}{pokud není spojení v bloku}

\comname{blockend}{}{ukonèení bloku pro odlo¾enou zmìnu priority}
\comret{DEVDEM\_E\_SYSTEM}{pokud spojení není v bloku}

\section{Kamera}

\comname{info}{}{vypí¹e informace o kameøe}
\comvalue{type}{[typ kamery]}{}
\comvalue{serial}{[sériové èíslo kamery]}{}
\comvalue{chips}{[poèet èipù kamery]}{}
\comvalue{temperature\_regulation}{[CAMERA\_COOL\_HOLD|CAMERA\_COOL\_MAX|CAMERA\_COOL\_OFF]}{stav
chazení kamery}
\comvalue{temperature\_setpoint}{[teplota]}{teplota, na kterou se
kamera sna¾í chladit}
\comvalue{air\_temperature}{[teplota]}{hodnota teplotního èidla,
udávajícího teplotu vzducju}
\comvalue{ccd\_temperature}{[teplota]}{teplota CCD èipu}
\comvalue{cooling\_power}{[promile výkonu]}{hodnota hlazení}
\comvalue{fan}{[0|1]}{stav vìtráku kamery}

\comname{chipinfo}{[èíslo èipu]}{vrací informace o daném èipu}
\comvalue{chip [èíslo èipu] width}{[¹íøka]}{¹íøka èipu}
\comvalue{chip [èíslo èipu] height}{[vý¹ka]}{vý¹ka èipu}
\comvalue{chip [èíslo èipu] binning\_vertical}{[vertikální binning]}{}
\comvalue{chip [èíslo èipu] binning\_horizontal}{[horizontální
binning]}{}
\comvalue{chip [èíslo èipu] pixelX}{[rozmìr pixelu v X smìru]}{}
\comvalue{chip [èíslo èipu] pixelY}{[rozmìr pixelu v Y smìru]}{}
\comvalue{chip [èíslo èipu] gain}{[zisk v e/ADU]}{}

\comname{expose}{[èíslo èipu] [svìtlý/tmavý snímek] [expozièní
èas]}{zahájí na daném èipu expozici}

\comname{stopexpo}{[èíslo èipu]}{ukonèí expozici}

% \comname{progexpo}{[èíslo èipu]}{vrací informace o probíhající
% expozici}

\comname{binning}{[èíslo èipu] [vertikální binning] [horizontální
binning]}{zmìní binning èipu}

\comname{readout}{[èíslo èipu]}{zahájí vyèítaní èipu}
\comvalue{D connect}{[èíslo spojení] [host]:[port] [velikost dat]}
{informace o nutnosti navázat datové spojení na daný port}
Pøíkaz skonèí a¾ po úspì¹ném navázání spojení.

\comname{stopread}{[èíslo èipu]}{ukonèí vyèítání daného èipu}

\comname{cooltemp}{[temperature]}{nastaví teplotu chlazení èipu}

\section{Montá¾}

\comname{set}{[RA] [DEC]}{nastaví pozici montá¾e}

\comname{move}{[RA] [DEC]}{zahájí pøesun montá¾e na novou pozici}

\comname{info}{}{vypí¹e informace o montá¾i}
\comvalue{type}{[typ dalekohledu]}{}
\comvalue{serial\_number}{[sériové èíslo montá¾e]}
\comvalue{ra}{[RA]}{hodnota rektascenze montá¾e}
\comvalue{dec}{[DEC]}{hodnota deklinace montá¾e}
\comvalue{park\_dec}{[DEC]}{parkovací deklinace}
\comvalue{longtitude}{[zemìpisná délka]}{zemìpisná délka dalkohledu}
\comvalue{latitude}{[zemìpisná ¹íøka]}{zemìpisná ¹íøka dalekohledu}
\comvalue{siderealtime}{[èas]}{místní hvìzdný èas v okam¾iku
pozorování}
\comvalue{localtime}{[èas]}{obèanský èas v místì pozorování}
\comvalue{correction\_mark}{[èíslo korekce]}{èíslo poslední probìhnuté
korekce}

\comname{park}{}{zaparkuje dalekohled}

\section{Pøíklad komunikace}

Máme jedno zaøízení, které se jmenuje C0 a je CCD kamerou. K tomuto zaøízení
se pøipojuje jeden klient, který je chce provádìt ostøení kamery. Po svém
pøipojení se pokusí získat prioritu, zmìní teplotu chlazení kamery a provede
expozici následující vyètením získaného snímku.

Jméno u¾ivatele je petr, jeho heslo je 123456.

Kamera je umístìna na poèítaèi se jménem c0, její server bì¾í na portu 5556.
Datové porty zaèínají portem 5557.

V následujícím pøíkladì znaèí {\bf k} klienta, {\bf S} centrální server a {\bf
C0} kameru. Komunikace a je její smìr je urèen pomocí =>. 

\def\conn#1#2#3{
\noskip{\bf #1} $>$ {\bf #2} - #3
\newline
}

Napøíklad:

\conn{k}{S}{command 1}

znamená text "command 1" poslaný klientem centrálnímu serveru.

\hskip{0.5cm}

\conn{C0}{S}{register C0 3 c0:5556}
\conn{S}{C0}{I status\_num 1}
\conn{S}{C0}{I status 0 server\_st 2}
Centrální server zdìlil kameøe, ¾e má jeden stav, jeho jméno je server\_st a
jeho hodnota je rovná 1.
\conn{S}{C0}{+000 Success}

\conn{k}{S}{login petr}
\conn{S}{k}{+000 Success}
\conn{k}{S}{password 123456}
\conn{S}{k}{logged\_as 0}
\conn{S}{k}{I status\_num 1}
\conn{S}{k}{I status 0 server\_st 2}
\conn{S}{k}{+000 Success}

\conn{k}{S}{info}
\conn{S}{k}{user 0 petr -1 -}
\conn{S}{k}{device 0 C0 c0:5556 3}
\conn{S}{k}{+000 Success}
Je pøipojen jeden u¾ivatel - to je na¹e spojení, a jedno zaøízení - c0.

\conn{k}{S}{key C0}
\conn{S}{k}{authorization\_key 23456}
\conn{S}{k}{+000 Success}

Klient po¾ádal o autorizaèní klíè.

\conn{k}{C0}{auth 0 23456}
\conn{C0}{S}{authtorize 0 23456}
\conn{S}{C0}{authorization\_ok 0}
\conn{S}{C0}{+000 Success}

Server potvrdil pravost klíèe pro klienta.

\conn{C0}{k}{I status\_num 3}
\conn{C0}{k}{I status 0 img\_chip 0}
\conn{C0}{k}{I status 1 trc\_chip 0}
\conn{C0}{k}{I status 2 priority 0}
\conn{C0}{k}{+000 Success}

Klient byl autorizován, kamera mu zdìlila poèet, názvy a hodnoty stavù.

\conn{k}{C0}{ready}
\conn{C0}{k}{+000 Success}

\conn{k}{C0}{info}
\conn{C0}{k}{type ST8}
\conn{C0}{k}{serial  819901486}
\conn{C0}{k}{chips 2}
\conn{C0}{k}{temperature\_regulation 0}
\conn{C0}{k}{temperature\_setpoint 1000.0}
\conn{C0}{k}{air\_temperature 17.39}
\conn{C0}{k}{ccd\_temperature 13.51}
\conn{C0}{k}{cooling\_power 0}
\conn{C0}{k}{fan 0}
\conn{C0}{k}{+000 Success}

\conn{k}{C0}{cooltemp -10}
\conn{C0}{k}{+000 Success}

\conn{k}{C0}{expose 0 1 120}
\conn{C0}{k}{S img\_chip 1 exposure chip started}
\conn{C0}{k}{+000 Success}

\conn{C0}{k}{S img\_chip 4 exposure chip finished}

\conn{k}{C0}{readout 0}
\conn{C0}{k}{D connect 8 C0:5565 3145784}

Klient vytvoøí datové spojení a zaène na nìm pøijímat data. Data budou dlouhá
3145784 bytù.

\conn{C0}{k}{S img\_chip 2 reading chip started}
\conn{C0}{k}{+000 Success}

\conn{C0}{k}{S img\_chip 0 reading chip finished}

Server odeslal poslední data, klient musí pøeèíst v¹echny data z datového
spojení a porovnat je s délkou dat, kterou obdr¾el na zaèátku spojení.
