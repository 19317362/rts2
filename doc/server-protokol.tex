\section{Protokol}

V následujícím textu je za {\bf server} oznaèován proces, který èeká na
spojení. Jako {\bf klient} je pak oznaèován proces, který spojení otvírá.

Je potøeba rozli¹ovat klienty pro jednotlivé èinnosti (monitoring, ..) s
klienty v protokolu.  

Proces centrálního serveru vystupuje v protokolu pouze jako sever. 

Klientské procesy vystupují v protokolu v¾dy jako klienty. Zaøízení, na které
se pøipojují, jsou servery. 

Zaøízení vystupují pøi komunikaci s centrálním server jako klient. Pøi
komunikaci mezi zaøízeními se jedno chová jako klient a druhé jako server.

\subsection{Formát}

Komunikace mù¾e probíhat buï pomocí binárních nebo textových zpráv.

Binární komunikace je tì¾ká pro pochopení pøi pohledu zvenèí, vy¾aduje
pou¾ívání pøesných volání. Binární komunikace je svázána s architekturou, na
které funguje. Pøi jejím pøíjmu na jiné architektuøe je vìt¹inou zapotøebí ji
nejdøíve konvertovat.

Textové rozhranní lze pøi pohledu zvenèí snadno pochopit. Je nároènìj¹í na
systémové prostøedky ne¾ binární komunikace - jsou pøená¹ena del¹í data,
pøijaté pøíkazy je potøeba pøed zpracováním detekovat.

Systém pou¾ívá pro pøenos pøíkazù a zpráv textové komunikace. Pro pøenos
binárních dat (snímkù) se pou¾ívá binárního formátu.

Bloky komunikace v textovém rozhranní jsou ukonèovány znaèkou konce øádky.
Buïto se pou¾ívá znakù platných v protokolu Telnet \cite{telnet} - tedy znaku
CR následovaného znakem LF, nebo pouze znaku LF.

Jednotlivé polo¾ky øádku jsou oddìlovány nejménì jedním znakem mezera.

\subsection{Pøíkazy}

Pøíkazy posílá klient serveru. První polo¾kou øádku je název pøíkazu.
Název pøíkazu je následován parametry.

Na jedné øádce je mo¾né poslat nìkolik pøíkazù. Jako jejich oddìlovaè slou¾í
støedník.

\subsection{Odpovìdi}

Server na pøíkazy odpovídá. Odpovìï serveru je v¾dy zakonèena øádkou,
zaèínající znakem '+' nebo '-' a pokraèující stavovým kódem slo¾eným ze tøí
èíslic. Server zaène dal¹í pøíkaz pøijatý od klienta zpracovávat a¾ po
odeslání zakonèovací øádky.

Pokud je prvním znakem zakonèovací øádky '+', pøíkaz byl úspì¹nì vykonán.
Pokud je tímto znakem '-', pøíkaz skonèil chybou. Podle stavového kódu lze pak
rozli¹it, o jakou chybu se jednalo.

Øádky obsahující promìnné zaèínají malým písmenem. Posílá je server klientovi,
vìt¹inou jako reakci na pøíkaz a tedy pøed tím, ne¾ oznámí ukonèení pøíkazu.
První polo¾ka je název promìnné, druhá její hodnota.

Napøíklad po dotazu na pozici montá¾e mù¾e montá¾ odpovìdìt {\it ra
10}, co¾ znamená, ¾e je v rektascenzi nastavena na 10 stupòù.

\subsection{Zprávy a ¾ádosti serveru}

Øádky, které posílá server klientovi a které zaèínají velkým písmenem obsahují
buïto zprávy, nebo ¾ádosti serveru. Mohou se vyskytovat kdykoliv v prùbìhu
komunikace klienta se serverem. Klient jejich pøíjem nepotvrzuje.

\subsubsection{Stavové zprávy}

Zaèínají znakem 'S', a obsahují název stavu, jeho novou hodnotu a doplòující
komentáø.

\subsubsection{Otevøení datového spojení}

®ádosti pro otevøení nového datového spojení zaèínají písmenem D. Poté
následuje øetìzec connect, jméno nebo IP adresa a port, na který se má klient
pøipojit. Poslední je délka bloku pøená¹ených dat.

Klient by se po pøijetí této ¾ádosti mìl pokusit o navázání spojení na danou
sí»ovou adresu.

\subsubsection{Zprávy}

Zprávy zaèínají písmenem M, za kterým následuje text zprávy.

\subsubsection{Informaèní zprávy}

Zaèínají písmenem I. Informují klienta o zmìnì hodnot stavu serveru, a o
pøipojených klientech.

\subsection{Pøenos snímkù}

Snímky se pøená¹ejí pøes datové spojení. Pøenos zaèíná hlavièkou, ve které je
uvedena velikost a formát snímku.

\section{Pøíkazy protokolu}

\def\comname#1#2#3{
\noindent{\bf #1} {\it #2} #3
\newline}

\def\comvalue#1#2#3{
{\it #1} { #2} #3
\newline}

\def\comret#1#2{
{\it E:}{\bf #1} #2
\newline}

\subsection{Konvence}

{\bf Tuènì} je vysázeno jméno pøíkazu a jméno návratové hodnoty. Návratové
hodnoty lze nalést v souboru include/status.h.

{\it Kurzívou a v [hranatých závorkách]} jsou vysázeny parametry
pøíkazu. V [hranatých závorkách] jsou vysázeny hodnoty promìnných.

\subsection{Obecné návratové hodnoty}

Zaøízení vrací 0, pokud po¾adovaná operace probìhla úspì¹nì. Pokud
pøíkaz neexistuje, nebo klient není autorizován pro provádìní daného
pøíkazu, vrací hodnotu DEVDEM\_E\_COMMAND. Pokud je pro pøíkaz zadán
nesprávný poèet parametrù, vrací hodnotu DEVDEM\_E\_PARAMSVAL.

\subsection{Serverd}

\subsubsection{Inicializaèní pøíkazy}

\comname{login}{[jméno u¾ivatele]}{zahájí proces pøihlá¹ení do systému}
\comret{DEVDEM\_E\_COMMAND}{klient je ji¾ pøihlá¹en nebo registrován}
\comret{DEVDEM\_E\_SYSTEM}{není mo¾né pøihlásit dal¹ího u¾ivatele}

\comname{password}{[heslo]}{pøihlásí u¾ivatele do systému}
\comvalue{logged\_as}{[èíslo spojení]}{èíslo spojení na stranì serveru,
pou¾ívané pro dal¹í autentifikaci}
\comvalue{I status\_num}{[poèet stavù]}{}
\comvalue{I status}{[èíslo stavu] [název stavu] [souèasná hodnota stavu]}{}
\comret{DEVDEM\_E\_SYSTEM}{heslo neodpovídá}

\comname{register}{[jméno zaøízení] [typ zaøízení] [host]:[port]}{zaregistruje nové zaøízení}
\comret{DEVDEM\_E\_SYSTEM}{zaøízení se stejným jménem je ji¾
zaregistrováno}

\subsubsection{Informaèní pøíkazy}

\comname{info}{}{vypí¹e informace o pøipojených zaøízeních a pøipojených klientech}
\comvalue{user}{[id] [priorita] [*|-] [jméno u¾ivatele] [popis provádìnné èinnosti]}
{informace o pøipojeném klientu - jeho èíslo, priority, zda je klientem s
nejvy¹í prioritou èi ne, a struèný popis, o jakého klienta se jedná}
\comvalue{device}{[èíslo zaøízení] [jméno zaøízení] [host]:[port] [typ zaøízení]}
{informace o pøipojeném zaøízení}
 
\comname{key}{[jméno zaøízení]}{vy¾ádá si klíè pro autorizaci}
\comvalue{authorization\_key}{[jméno zaøízení] [klíè]}{autorizaèní
klíè pro dané zaøízení}
\comret{DEVDEM\_E\_SYSTEM}{zaøízení neexisuje}

\comname{priority}{[nová priorita]}{zmìní prioritu daného spojení}
\comvalue{old\_priority}{[hodnota priority]}{souèasná priorita spojení}
\comvalue{actual\_priority}{[èíslo spojení dr¾ícího prioritu]
[hodnota jeho priority]}{spojení s nejvìt¹í prioritou}
\comvalue{new\_priority}{[èíslo spojení dr¾ící prioritu] [hodnota priority]}
{spojení s prioritou po provedení zmìny}
\comret{DEVDEM\_E\_PRIORITY}{pokud zmìna priority nemohla probìhnout}

\comname{prioritydeferred}{[nová priorita]}{provede odlo¾enou
zmìnu priroty}

\comname{on}{}{zmìní stav serveru na jeden z operaèních stavù, v
závislosti na aktuálním èase a datu}

\comname{standby}{}{pøepne server do jednoho ze stavù "standby" re¾imu}

\comname{ready}{}{pokud je server ve standby re¾imu, pøepne ho do jednoho ze
stavù "on" re¾imu}

\comname{off}{}{zmìní stav serveru na "off"}

\subsection{Zaøízení - obecná komunikace}

Pokud není klient autorizován, vrací v¹echna komunikace hodnotu
DEVDEM\_E\_SYSTEM.

Pokud dojde pøi vykonávání pøíkazu k chybì v komunikaci se zaøízením,
vrací se hodnota DEVDEM\_E\_HW.

\comname{auth}{[èíslo spojení] [autentifikaèní klíè]}{provede
autorizaci}
\comvalue{I status\_num}{[poèet stavù]}{}
\comvalue{I status}{[èíslo stavu] [jméno stavu] [hodnota stavu]}
{informace o stavu zaøízení}
\comret{DEVDEM\_E\_SYSTEM}{pokud autorizace neprobìhla}

\comname{ready}{}{zjistí, jestli je zaøízení pøipojeno. Je mo¾né volat
opakovanì.}

\comname{help}{}{vypí¹e nápovìdu}

\comname{exit}{}{ukonèí spojení}

\comname{blockstart}{}{informuje zaøízení o zaèátku bloku, nutné pro
provedení odlo¾ené zmìny priority}
\comret{DEVDEM\_E\_SYSTEM}{pokud je spojení ji¾ v bloku}

\comname{blockcheck}{}{odlo¾ená zmìna priority je mo¾ná}
\comret{DEVDEM\_E\_SYSTEM}{pokud není spojení v bloku}

\comname{blockend}{}{ukonèení bloku pro odlo¾enou zmìnu priority}
\comret{DEVDEM\_E\_SYSTEM}{pokud spojení není v bloku}

\subsection{Kamera}

\comname{info}{}{vypí¹e informace o kameøe}
\comvalue{type}{[typ kamery]}{}
\comvalue{serial}{[sériové èíslo kamery]}{}
\comvalue{chips}{[poèet èipù kamery]}{}
\comvalue{temperature\_regulation}{[0 | 1 | 2]}{stav chazení kamery - chlazení vypnuto, chladím na maximální výkon, dr¾ím teplotu chlazení}
\comvalue{temperature\_setpoint}{[teplota]}{teplota, na kterou se
kamera sna¾í chladit}
\comvalue{air\_temperature}{[teplota]}{hodnota teplotního èidla,
udávají teplotu vzduchu}
\comvalue{ccd\_temperature}{[teplota]}{teplota CCD èipu}
\comvalue{cooling\_power}{[promile výkonu]}{hodnota chlazení}
\comvalue{fan}{[0|1]}{stav vìtráku kamery}

\comname{chipinfo}{[èíslo èipu]}{vrací informace o daném èipu}
\comvalue{chip [èíslo èipu] width}{[¹íøka]}{¹íøka èipu}
\comvalue{chip [èíslo èipu] height}{[vý¹ka]}{vý¹ka èipu}
\comvalue{chip [èíslo èipu] binning\_vertical}{[vertikální binning]}{}
\comvalue{chip [èíslo èipu] binning\_horizontal}{[horizontální
binning]}{}
\comvalue{chip [èíslo èipu] pixelX}{[rozmìr pixelu v ose X]}{}
\comvalue{chip [èíslo èipu] pixelY}{[rozmìr pixelu v ose Y]}{}
\comvalue{chip [èíslo èipu] gain}{[zisk v e/ADU\footnote{velikost dopadnuté
energie, potøebné k zvý¹ení hodnoty pixelu o jednièku}]}{}

\comname{expose}{[èíslo èipu] [svìtlý/tmavý snímek] [expozièní
èas]}{zahájí na daném èipu expozici}

\comname{stopexpo}{[èíslo èipu]}{ukonèí expozici}

% \comname{progexpo}{[èíslo èipu]}{vrací informace o probíhající
% expozici}

\comname{binning}{[èíslo èipu] [vertikální binning] [horizontální
binning]}{zmìní binning èipu}

\comname{readout}{[èíslo èipu]}{zahájí vyèítaní èipu}
\comvalue{D connect}{[èíslo spojení] [host]:[port] [velikost dat]}
{informace o nutnosti navázat datové spojení na daný port}
Pøíkaz skonèí a¾ po úspì¹ném navázání spojení.

\comname{stopread}{[èíslo èipu]}{ukonèí vyèítání daného èipu}

\comname{cooltemp}{[temperature]}{nastaví teplotu chlazení èipu}

\subsection{Montá¾}

\comname{set}{[RA] [DEC]}{nastaví pozici montá¾e}

\comname{move}{[RA] [DEC]}{zahájí pøesun montá¾e na novou pozici}

\comname{info}{}{vypí¹e informace o montá¾i}
\comvalue{type}{[typ dalekohledu]}{}
\comvalue{serial\_number}{[sériové èíslo montá¾e]}
\comvalue{ra}{[RA]}{hodnota rektascenze montá¾e}
\comvalue{dec}{[DEC]}{hodnota deklinace montá¾e}
\comvalue{park\_dec}{[DEC]}{parkovací deklinace}
\comvalue{longtitude}{[zemìpisná délka]}{zemìpisná délka dalkohledu}
\comvalue{latitude}{[zemìpisná ¹íøka]}{zemìpisná ¹íøka dalekohledu}
\comvalue{siderealtime}{[èas]}{místní hvìzdný èas v okam¾iku
pozorování}
\comvalue{localtime}{[èas]}{obèanský èas v místì pozorování}
\comvalue{correction\_mark}{[èíslo korekce]}{èíslo poslední probìhnuté
korekce}

\comname{park}{}{zaparkuje dalekohled}

\section{Pøíklad komunikace}

Máme jedno zaøízení, které se jmenuje C0 a je CCD kamerou. K tomuto zaøízení
se pøipojuje jeden klient, který je chce provádìt ostøení kamery. Po svém
pøipojení se pokusí získat prioritu, zmìní teplotu chlazení kamery a provede
expozici následovanou vyètením získaného snímku.

Jméno u¾ivatele je petr, jeho heslo je 123456.

Kamera je umístìna na poèítaèi se jménem c0, její server bì¾í na portu 5556.
Datové porty zaèínají portem 5557.

V následujícím pøíkladu znaèí {\bf k} klienta, {\bf S} centrální server a {\bf
C0} kameru. Komunikace a je její smìr je znaèena pomocí >. 

\def\conn#1#2#3{
\noindent{\bf #1} $>$ {\bf #2} - #3
\newline
}

Napøíklad:
\newline
\conn{k}{S}{command 1}
\newline
znamená text "command 1" poslaný klientem centrálnímu serveru.

\hskip 0.5cm

\conn{C0}{S}{register C0 3 c0:5556}
\conn{S}{C0}{I status\_num 1}
\conn{S}{C0}{I status 0 server\_st 2}

Centrální server sdìlil kameøe, ¾e má jeden stav, jeho jméno je server\_st a
jeho hodnota je rovná 1.

\conn{S}{C0}{+000 Success}

\conn{k}{S}{login petr}
\conn{S}{k}{+000 Success}
\conn{k}{S}{password 123456}
\conn{S}{k}{logged\_as 0}
\conn{S}{k}{I status\_num 1}
\conn{S}{k}{I status 0 server\_st 2}
\conn{S}{k}{+000 Success}

\conn{k}{S}{info}
\conn{S}{k}{user 0 petr -1 -}
\conn{S}{k}{device 0 C0 c0:5556 3}
\conn{S}{k}{+000 Success}

Je pøipojen jeden u¾ivatel - to je na¹e spojení, a jedno zaøízení - C0.

\conn{k}{S}{key C0}
\conn{S}{k}{authorization\_key 23456}
\conn{S}{k}{+000 Success}

Klient po¾ádal o autorizaèní klíè.

\conn{k}{C0}{auth 0 23456}
\conn{C0}{S}{authorize 0 23456}
\conn{S}{C0}{authorization\_ok 0}
\conn{S}{C0}{+000 Success}

Server potvrdil pravost klíèe pro klienta.

\conn{C0}{k}{I status\_num 3}
\conn{C0}{k}{I status 0 img\_chip 0}
\conn{C0}{k}{I status 1 trc\_chip 0}
\conn{C0}{k}{I status 2 priority 0}
\conn{C0}{k}{+000 Success}

Klient byl autorizován, kamera mu sdìlila poèet, názvy a hodnoty stavù.

\conn{k}{C0}{ready}
\conn{C0}{k}{+000 Success}

\conn{k}{C0}{info}
\conn{C0}{k}{type ST8}
\conn{C0}{k}{serial  819901486}
\conn{C0}{k}{chips 2}
\conn{C0}{k}{temperature\_regulation 0}
\conn{C0}{k}{temperature\_setpoint 1000.0}
\conn{C0}{k}{air\_temperature 17.39}
\conn{C0}{k}{ccd\_temperature 13.51}
\conn{C0}{k}{cooling\_power 0}
\conn{C0}{k}{fan 0}
\conn{C0}{k}{+000 Success}

Klient získal informace o kameøe.

\conn{k}{C0}{cooltemp -10}
\conn{C0}{k}{+000 Success}

Klient nastavil teplotu chlazení.

\conn{k}{C0}{expose 0 1 120}
\conn{C0}{k}{S img\_chip 1 exposure chip started}
\conn{C0}{k}{+000 Success}

\conn{C0}{k}{S img\_chip 4 exposure chip finished}

\conn{k}{C0}{readout 0}
\conn{C0}{k}{D connect 8 C0:5565 3145784}

Klient vytvoøí datové spojení a zaène na nìm pøijímat data. Délka dat urèených
k pøijmutí je 3145784 bytù.

\conn{C0}{k}{S img\_chip 2 reading chip started}
\conn{C0}{k}{+000 Success}

\conn{C0}{k}{S img\_chip 0 reading chip finished}

Server odeslal poslední data, klient musí pøeèíst v¹echna data z datového
spojení a porovnat je s délkou dat, kterou obdr¾el na zaèátku spojení.
