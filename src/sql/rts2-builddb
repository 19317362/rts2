#!/bin/bash

DBNAME=$1
PSQL=psql

PSQLDB="$PSQL $DBNAME"

if [ "x$DBNAME" == "x" ]; then
  echo "Usage: $0 <db_name>"
  exit 1
fi

$PSQLDB -c "select * from pg_tables" 2>&1 >/dev/null
if [ $? != 0 ]; then
  echo "Cannot execute psql / you don't have access to database '$DBNAME'"
  exit 2
fi

# build database

$PSQLDB < create/language.sql
$PSQLDB < create/typ_wcs.sql
$PSQLDB < create/functions.sql
$PSQLDB < create/tables.sql
$PSQLDB < create/views.sql

# update to current version

cd update

for x in rel_*.sql; do
	echo Applying updates to relase $x
	$PSQLDB < $x
done

# load init data

$PSQLDB < init_data.sql

# if asked, load Landoldts and planets
echo -n "Would you like to create Landolt calibration fields targets [Y|n]?"
read repl

if [ "x$repl" = 'xY' -o "x$repl" = 'xy' -o "x$repl" = 'x' ]; then
  $PSQLDB < data/landolt.sql
  echo "Landolt fields targets created."
else
  echo "Landolt fields targets skipped."
fi

echo -n "Would you like to create targets for planets [Y|n]?"
read repl
if [ "x$repl" = 'xY' -o "x$repl" = 'xy' -o "x$repl" = 'x' ]; then
  $PSQLDB < data/planets.sql
  echo "Planet targets created"
else
  echo "Planet targets skipped."
fi

# grant rights

$PSQLDB < grant.sql
