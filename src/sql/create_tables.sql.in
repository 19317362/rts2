DROP TABLE ot;
DROP TABLE grb;
DROP TABLE targets;
DROP TABLE epoch;
DROP TABLE types;

CREATE TABLE epoch (
	epoch_id	char(3) PRIMARY KEY,		
	epoch_start	timestamp,
	epoch_end	timestamp
);

CREATE TABLE types (
	type_id		char PRIMARY KEY,
	type_description varchar(200)
);

CREATE TABLE targets (
	tar_id		integer PRIMARY KEY,
	type_id		char REFERENCES types(type_id),
	tar_name	varchar(150),
	tar_ra		float4,
	tar_dec		float4,
	tar_comment	text,
	tar_lastobs	timestamp DEFAULT NULL
);

CREATE TABLE grb (
	tar_id		integer REFERENCES targets (tar_id),
	grb_id		integer PRIMARY KEY,
	grb_seqn	integer,
	grb_date	timestamp,
	grb_last_update	timestamp
);

CREATE TABLE ot (
	tar_id		integer REFERENCES targets (tar_id),
	ot_imgcount	integer,
	ot_minpause	interval DEFAULT NULL,
	ot_priority	integer
);

DROP TABLE darks;

CREATE TABLE darks (
	dark_name	varchar(250) NOT NULL,
	dark_date	timestamp,
	dark_exposure	integer,
	dark_temperature integer,
	epoch_id	char(3) NOT NULL REFERENCES epoch(epoch_id),
	camera_name	varchar(8) REFERENCES cameras(camera_name)
);

DROP TABLE flats;

CREATE TABLE flats ( 
	flat_name	varchar(250) NOT NULL,
	flat_date	timestamp,
	flat_exposure	integer,
	flat_temperature integer,
	epoch_id	char(3) NOT NULL REFERENCES epoch(epoch_id),
	camera_name	varchar(8) REFERENCES cameras(camera_name)
);

DROP SEQUENCE tar_id;

CREATE SEQUENCE tar_id;

DROP TABLE observations;

CREATE TABLE observations (
	tar_id		integer REFERENCES targets (tar_id),
	obs_id		integer PRIMARY KEY,
	obs_start	timestamp,
	obs_duration	interval,
	obs_imagescount integer DEFAULT 0 -- number of images taken
);

CREATE INDEX observations_tar_id ON observations (tar_id);

DROP SEQUENCE obs_id;

CREATE SEQUENCE obs_id;

DROP TABLE cameras;

CREATE TABLE cameras (
	camera_name	varchar(8) PRIMARY KEY,
	camera_description	varchar(100)
);

DROP TABLE mounts;

CREATE TABLE mounts (
	mount_name	varchar(8) PRIMARY KEY,
	mount_long	float,
	mount_lat	float,
	mount_alt	float,
	mount_desc	varchar(100)
);

DROP VIEW observations_nights;

CREATE VIEW observations_nights AS 
	SELECT *, extract (day from (obs_start - interval '12:0:0')) AS obs_night,
		extract (month from (obs_start - interval '12:0:0')) AS obs_month,
		extract (year from (obs_start - interval '12:0:0')) AS obs_year
		FROM observations;

DROP VIEW images_nights;

CREATE VIEW images_nights AS 
	SELECT *, extract (day from (img_date - interval '12:0:0')) AS img_night, 
		extract (month from (img_date - interval '12:0:0')) AS img_month,
		extract (year from (img_date - interval '12:0:0')) AS img_year
		FROM images;

GRANT SELECT ON grb TO "@WWWUSER@";
GRANT SELECT ON targets TO "@WWWUSER@";
GRANT SELECT ON observations TO "@WWWUSER@";
GRANT SELECT ON ot TO "@WWWUSER@";
GRANT SELECT ON cameras TO "@WWWUSER@";
GRANT SELECT ON mounts TO "@WWWUSER@";

GRANT ALL ON grb TO GROUP observers;
GRANT ALL ON targets TO GROUP observers;
GRANT ALL ON observations TO GROUP observers;
GRANT ALL ON ot TO GROUP observers;
GRANT ALL ON cameras TO GROUP observers;
GRANT ALL ON mounts TO GROUP observers;

GRANT SELECT ON images_nights TO observers;
GRANT SELECT ON observations_nights TO observers;
