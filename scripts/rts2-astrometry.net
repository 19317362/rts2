#!/usr/bin/python

import pyfits
import rts2.dms
import rts2.libnova

import math
import sys
from optparse import OptionParser

def run_on_image(fn, verbose=False, blind=False, multiwcs='', wcs_keys=None, radius=5, scale_relative_error=0.05, timeout=None, print_results=True, x_offset=None, y_offset=None, odir=None, bashrc=None):
	import rts2.astrometry
	a = rts2.astrometry.AstrometryScript(fn, scale_relative_error=scale_relative_error, odir=odir)

	ff=pyfits.fitsopen(fn,'readonly')

	ra = dec = scale = None

	if not(blind):
		if wcs_keys is not None:
			ra=ff[0].header[wcs_keys[0]]
			dec=ff[0].header[wcs_keys[1]]
			scale=abs(float(ff[0].header[wcs_keys[2]])) * 3600.0

			# parse WCS keys
			try:
				ra = float(ra)
			except ValueError:
				ra = rts2.dms.parseDMS(ra) * 15.0
			try:
				dec = float(dec)
			except ValueError:
				dec = rts2.dms.parseDMS(dec)
		else:
			ra=ff[0].header['CRVAL1' + multiwcs]
			dec=ff[0].header['CRVAL2' + multiwcs]

			for k in ['CDELT1' + multiwcs,'CD1_1' + multiwcs]:
				try:
					scale=abs(float(ff[0].header[k]) * 3600.0)
					break
				except KeyError,ke:
					pass

	object = None

	try:
		object=ff[0].header['OBJECT']
	except KeyError,ke:
		pass
			
	ff.close()

	ret=a.run(replace=True,verbose=verbose) if blind else a.run(scale=scale, ra=ra, dec=dec, radius=radius, replace=True, timeout=timeout, verbose=verbose)

	if ret and print_results:
		# script needs to reopen file 
		
		ff=pyfits.fitsopen(odir + '/' + fn, 'readonly')
		fh=ff[0].header
		ff.close()

		raorig=ra
		decorig=dec

		rastrxy = rts2.astrometry.xy2wcs(fh['NAXIS1']/2.0, fh['NAXIS2']/2.0, fh)

		#rastrxy=[float(ret[0])*15.0,float(ret[1])]

		err = rts2.libnova.angularSeparation(raorig, decorig, rastrxy[0] + x_offset/3600.0, rastrxy[1] + y_offset/3600.0)

		ra_err = math.cos(math.radians(decorig))*((raorig-rastrxy[0])-x_offset/3600.0)
		dec_err = decorig-rastrxy[1]-y_offset/3600.0

		print "corrwerr 1 {0:.10f} {1:.10f} {2:.10f} {3:.10f} {4:.10f}".format(rastrxy[0], rastrxy[1], ra_err, dec_err, err)

		import rts2.scriptcomm
		c = rts2.scriptcomm.Rts2Comm()
		c.doubleValue('real_ra','[hours] image ra as calculated from astrometry',rastrxy[0])
		c.doubleValue('real_dec','[deg] image dec as calculated from astrometry',rastrxy[1])

		c.doubleValue('tra','[hours] telescope ra',raorig)
		c.doubleValue('tdec','[deg] telescope dec',decorig)

		if x_offset is not None:
			c.doubleValue('xoffs', '[arcsec] x offset', x_offset)
		if y_offset is not None:
			c.doubleValue('yoffs', '[arcsec] y offset', x_offset)

		c.doubleValue('ora','[arcdeg] offsets ra as calculated from astrometry',ra_err * 3600.0)
		c.doubleValue('odec','[arcdeg] offsets dec as calculated from astrometry',dec_err * 3600.0)

		c.stringValue('object','astrometry object',object)

	if ret is not None:
		if bashrc is not None:
			rcfile = open(bashrc, 'w+')
			rcfile.write('export ra_err={0}\nexport dec_err={1}\nexport err={2}'.format(ra_err, dec_err, err))
			rcfile.close()
		return 0
	return 1

parser = OptionParser()
parser.add_option('--multi-wcs', help='Multiple WCS extension', action='store', dest='multiwcs', default='')
parser.add_option('--wcs-keys', help='WCS keys (RA, DEC, scale) separated with ","', action='store', dest='wcs_keys', default=None)
parser.add_option('--blind', help='Blind solve', action='store_true', dest='blind', default=False)
parser.add_option('--radius', help='Error radius', action='store', dest='radius', default=5)
parser.add_option('--scale-error', help='scale error in %', action='store', dest='scale_error', default=5)
parser.add_option('--tmp-dir', help='temporary directory', action='store', dest='temp_dir', default=None)
parser.add_option('--timeout', help='Process timeout', action='store', dest='timeout', default=None)
parser.add_option('--verbose', help='Be verbose, print what the script is doing', action='store_true', dest='verbose', default=False)
parser.add_option('--quiet', help="don't compute ora, odec,..", action='store_true', dest='quiet', default=False)
parser.add_option('--xoffset', help="X offset (used in mosaic images)", action='store', dest='x_offset', default=None)
parser.add_option('--yoffset', help="Y offset (used in mosaic images)", action='store', dest='y_offset', default=None)
parser.add_option('--bashrc', help="write results into bash export file", action="store", dest="bashrc", default=None)

(options,args) = parser.parse_args()

if not(len(args) == 1):
	print 'Usage: {0} <fits filenames>'.format(sys.argv[0])
	sys.exit(1)

wcs_keys = None

if options.wcs_keys:
	wcs_keys = options.wcs_keys.split(',')

if options.timeout is not None:
	options.timeout = int(options.timeout)

ret = 0	

for x in args:
	ret += run_on_image(x, verbose=options.verbose, blind=options.blind, multiwcs=options.multiwcs, wcs_keys=wcs_keys, radius=float(options.radius), scale_relative_error=float(options.scale_error) / 100.0, timeout=options.timeout, print_results=not(options.quiet), x_offset=float(options.x_offset), y_offset=float(options.y_offset), odir=options.temp_dir, bashrc=options.bashrc)

sys.exit(ret)
